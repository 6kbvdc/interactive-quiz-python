import random
import os
import time
from datetime import datetime

# Colors for terminal
class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    RESET = '\033[0m'

RESULTS_FILE = "results.txt"

# Base questions by category and difficulty
QUESTIONS = {
    "Math": {"easy": [], "medium": [], "hard": []},
    "Logic": {"easy": [], "medium": [], "hard": []},
    "Python": {"easy": [], "medium": [], "hard": []}
}

# Generate Math, Logic, Python questions
def generate_questions():
    # Math
    while len(QUESTIONS["Math"]["easy"]) < 20:
        a,b = random.randint(1,20), random.randint(1,20)
        answer = a+b
        options = [answer, answer+1, answer-1, answer+2]
        random.shuffle(options)
        QUESTIONS["Math"]["easy"].append({
            "q":f"{a} + {b} =",
            "options":[f"{chr(65+i)}. {opt}" for i,opt in enumerate(options)],
            "answer":chr(65+options.index(answer))
        })
    while len(QUESTIONS["Math"]["medium"]) < 20:
        a,b = random.randint(2,12), random.randint(2,12)
        answer = a*b
        options = [answer, answer+1, answer-1, answer+2]
        random.shuffle(options)
        QUESTIONS["Math"]["medium"].append({
            "q":f"{a} * {b} =",
            "options":[f"{chr(65+i)}. {opt}" for i,opt in enumerate(options)],
            "answer":chr(65+options.index(answer))
        })
    while len(QUESTIONS["Math"]["hard"]) < 20:
        a,b = random.randint(10,50), random.randint(1,10)
        answer = a//b
        options = [answer, answer+1, answer-1, answer+2]
        random.shuffle(options)
        QUESTIONS["Math"]["hard"].append({
            "q":f"{a} // {b} =",
            "options":[f"{chr(65+i)}. {opt}" for i,opt in enumerate(options)],
            "answer":chr(65+options.index(answer))
        })

    # Logic
    logic_easy = [
        ("If all cats are animals, are all animalsk cats?", ["A. Yes","B. No","C. Cannot tell","D. Maybe"],"B"),
        ("Series: 2,4,6,8,...?", ["A. 9","B. 10","C. 12","D. 11"],"B")
    ]
    logic_medium = [
        ("Yesterday was Monday, today is?", ["A. Sunday","B. Monday","C. Tuesday","D. Saturday"],"C"),
        ("Odd one out: 2,4,6,9,8", ["A. 2","B. 4","C. 6","D. 9"],"D")
    ]
    logic_hard = [
        ("Mary>John, John>Sam. Who is youngest?", ["A. Mary","B. John","C. Sam","D. Cannot tell"],"C"),
        ("Sequence:1,2,4,8,16,...?", ["A.20","B.32","C.24","D.18"],"B")
    ]
    for q,opt,ans in logic_easy*10: QUESTIONS["Logic"]["easy"].append({"q":q,"options":opt,"answer":ans})
    for q,opt,ans in logic_medium*10: QUESTIONS["Logic"]["medium"].append({"q":q,"options":opt,"answer":ans})
    for q,opt,ans in logic_hard*10: QUESTIONS["Logic"]["hard"].append({"q":q,"options":opt,"answer":ans})

    # Python
    python_easy = [
        ("Python function keyword?", ["A. func","B. def","C. function","D. define"],"B"),
        ("Python data type?", ["A. list","B. array","C. vector","D. table"],"A")
    ]
    python_medium = [
        ("len([1,2,3])?", ["A.2","B.3","C.4","D.1"],"B"),
        ("Exponent operator?", ["A. **","B.^","C.%","D.//"],"A")
    ]
    python_hard = [
        ("Immutable?", ["A. list","B. dict","C. tuple","D. set"],"C"),
        ("Index starts at?", ["A.0","B.1","C.-1","D.None"],"A")
    ]
    for q,opt,ans in python_easy*10: QUESTIONS["Python"]["easy"].append({"q":q,"options":opt,"answer":ans})
    for q,opt,ans in python_medium*10: QUESTIONS["Python"]["medium"].append({"q":q,"options":opt,"answer":ans})
    for q,opt,ans in python_hard*10: QUESTIONS["Python"]["hard"].append({"q":q,"options":opt,"answer":ans})

generate_questions()

# Category selection (multiple)
def choose_categories():
    print("\nSelect categories (comma separated, e.g., 1,3):")
    print("1. Math  2. Logic  3. Python")
    choice = input("Enter: ").replace(" ","").split(",")
    mapping = {"1":"Math","2":"Logic","3":"Python"}
    selected = [mapping[c] for c in choice if c in mapping]
    return selected if selected else ["Math"]

# Level selection
def choose_level():
    print("\nSelect difficulty:")
    print("1. Easy  2. Medium  3. Hard")
    choice = input("Enter 1/2/3: ")
    return {"1":"easy","2":"medium","3":"hard"}.get(choice,"easy")

# Progress bar
def print_progress(current,total):
    bar_len=20
    filled=int(bar_len*current/total)
    print(f"Progress: [{'#'*filled}{'-'*(bar_len-filled)}] {current}/{total}")

# Ask question with countdown
def ask_question(item, number, total, timeout=10):
    print(f"\nQuestion {number}: {item['q']}")
    for op in item["options"]:
        print(op)
    for t in range(timeout,0,-1):
        print(f"Time left: {t} sec", end='\r')
        time.sleep(1)
    ans = input("Your answer (A/B/C/D): ").upper()
    if ans == item["answer"]:
        print(f"{Colors.GREEN}Correct!{Colors.RESET}")
        correct=True
    else:
        print(f"{Colors.RED}Wrong. Correct answer is {item['answer']}{Colors.RESET}")
        correct=False
    print_progress(number,total)
    return correct

# Save leaderboard
def save_result(name,score,total):
    percent=round((score/total)*100,2)
    try:
        with open(RESULTS_FILE,"a") as f:
            f.write(f"{name},{score},{total},{percent},{datetime.now()}\n")
    except: print("Could not save results")

# Show top 10 leaderboard
def show_leaderboard():
    if not os.path.exists(RESULTS_FILE):
        print("\nNo leaderboard yet.")
        return
    scores=[]
    with open(RESULTS_FILE,"r") as f:
        for line in f:
            parts=line.strip().split(",")
            if len(parts)>=2:
                scores.append((parts[0],int(parts[1])))
    scores.sort(key=lambda x:x[1],reverse=True)
    print("\nTop 10 Leaderboard")
    for i,(name,score) in enumerate(scores[:10],1):
        print(i,".",name,"-",score)

# Run final mixed quiz
def run_quiz():
    print("=== Ultimate Mixed Quiz App ===")
    name=input("Enter your name: ")
    categories=choose_categories()
    level=choose_level()
    # Merge selected category questions
    merged=[]
    for cat in categories:
        merged.extend(QUESTIONS[cat][level])
    random.shuffle(merged)
    total=len(merged)
    score=0
    for i,q in enumerate(merged,1):
        if ask_question(q,i,total):
            score+=1
    print(f"\nFinal Score: {score}/{total}")
    save_result(name,score,total)
    show_leaderboard()

if __name__=="__main__":
    run_quiz()
